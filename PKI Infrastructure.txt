
_____________________
********************* Privilege Access Management

PAM Solution = JumpServer

https://127.0.0.1/ = NetOps IP

TASK 1. Create User Accounts on JumpServer
TASK 2. Add NetOps & VPN-PH, VPN-JP (CSR1000v), WinServer to JumpServer
TASK 3. Add an ACL to prevent certain configs
TASK 4. Audit Access to Devices.


___
*** Cryptographic Solutions

1. Password Authentication

1. Ephemeral KeyPair

V
Server             Client
Priv & Pub Keys    Priv & Pub Keys

Pub Key Exchange

- Combine Pub Key
Symmetrical Encryption


Create a user account on linux: rivan
!@NetOps
adduser -m rivan
passwd rivan
> C1sc0123
> C1sc0123

Make Rivan a Sudoer
!@NetOps
usermod -aG wheel rivan

Login as rivan
!@NetOps
su rivan
> C1sc0123





2. Publickey Authentication

LINUX

Create a user account on linux: alumni

!@NetOps
adduser -m alumni -p C1sc0123 -G wheel

Login as alumni
!@NetOps
su alumni
> C1sc0123

Create SSH Key Pair directory
!@NetOps
cd /home/alumni
mkdir .ssh
mkdir .ssh/sshstore
cd .ssh/sshstore

Generate Key Pair for alumni
!@NetOps
ssh-keygen -t rsa -b 2048 -f alumni
cat alumni.pub >> ../authorized_keys

Decrypt private key
!@NetOps
ssh-keygen -p

Disable Password Authentication
!@NetOps
nano /etc/ssh/sshd_config

PasswordAuthentication no

systemctl restart sshd


CISCO

Create a user account in Cisco with a key pair
!@CSR1000v & CoreTAAS
conf t
 line vty 0 14
  transport input all
  login local
  exec-timeout 0 0
  exit
 ip domain name rivan.com
 username admin privilege 15 secret pass
 username rivan privilege 15 
 crypto key generate rsa modulus 2048 label sec
 ip ssh rsa keypair-name sec
 ip ssh version 2
 end

Assign a public key to rivan
!@CSR1000v & CoreTAAS
conf t
 ip ssh pubkey-chain
  username rivan
   key-string

Paste the public key

On Jumpserver, enter the private key to access CoreTAAS & CSR1000v


Turn off password authentication for Cisco and Linux.
@NetOps
cd /etc/ssh/sshd_config

@UTM-PH
conf t
 no ip ssh server algorithm authentication password
 end


3. GSSAPI Authentication - KERBEROS - Token Authentication

Install Kerberos Server
sudo yum install krb5-server krb5-libs krb5-workstation

Set a default realm for the config file:
nano /etc/krb5.conf

    [libdefaults]
        default_realm = EXAMPLE.COM

    [realms]
        EXAMPLE.COM = {
            kdc = kerberos.example.com
            admin_server = kerberos.example.com
        }

    [domain_realm]
        .example.com = EXAMPLE.COM
        example.com = EXAMPLE.COM

        
Create Kerberos database
kdb5_util create -s

Make sure the default re
sudo kadmin.local 
addprinc admin/admin
exit

Start kerberos services
sudo systemctl start krb5kdc.service 
sudo systemctl start kadmin

kinit
klist
__________________________
*************************
PKI Infrastructure

"Root chain of trust"
A common trustpoint = CA

Root CA

  ^

Intermediate CA
  - Inter 1
  - Inter 2
  - Inter 3
  - ...

  ^

Leaf/Server CA - Issued/Signed by an Intermediate CA

_____________________
********************* Certificate Directory

LINUX
/usr/share/pki/ca-trust-source/anchors/
update-ca-trust

WINDOWS
certmgr.msc

_____________________
********************* Deploy CA Server & Issue Certificates

NetOps VM
	NetAdapter: NAT
	NetAdapter 2: VMNet2
	NetAdapter 3: VMNet3
	NetAdapter 4: Bridged (Replicate)

	Login: root
	Pass: C1sc0123
	

1. Configure IP addressing for NetAdapter 2 (Verify MAC ADDRESS of interface)

!@NetOps
ifconfig ens224 192.168.102.100 netmask 255.255.255.0 up


2. Create a directory for keys and certificates.

!@NetOps
cd
mkdir keystore
cd keystore

3. Create a Private key with a Selfsigned Certificate (x509)

!@NetOps
openssl req -x509 -newkey rsa:2048 -days 365 -keyout key-rivan.pem -out ca-rivan.pem -nodes


Sample Output:
-----
Country Name (2 letter code) [XX]:PH
State or Province Name (full name) []:NCR
Locality Name (eg, city) [Default City]:Makati
Organization Name (eg, company) [Default Company Ltd]:Rivancorp
Organizational Unit Name (eg, section) []:HQ
Common Name (eg, your name or your server's hostname) []:rivan.com
Email Address []:admin@rivancorp.com


Include -subj information so that no prompts appear:

!@NetOps
-subj "/C=PH/ST=NCR/L=Makati/O=Rivancorp/OU=HQ/CN=rivan.com/emailAddress=admin@rivancorp.com/subjectAltName=DNS:rivan.com,DNS:www.rivan.com,IP:192.168.102.100,DNS:software.rivan.com"


Display Certificate Info

!@NetOps
openssl x509 -in ca-rivan.pem -noout -text



4. Generate RSA Key Pair on both routers.

!@VPN-PH, VPN-JP
conf t
 crypto key generate rsa general-keys label rivankeys modulus 2048 exportable
 end



5. Create a trustpoint and import the CA.

!@VPN-PH
conf t
 crypto pki trustpoint rivantrust
  enrollment terminal pem
  hash sha512
  subject-name CN=siteph.rivan.com, C=PH, ST=NCR, L=Makati, O=Rivancorp, OU=SitePH, E=siteph@rivancorp.com
  subject-alt-name siteph.rivan.com
  subject-alt-name ph.rivan.com
  storage unix: 
  primary
  revocation-check none
  rsakeypair rivankeys
  exit
 crypto pki authenticate rivantrust
> Paste the CA


!@VPN-JP
conf t
 crypto pki trustpoint rivantrust
  enrollment terminal pem
  hash sha512
  subject-name CN=siteph.rivan.com, C=JP, ST=Kanto, L=Tokyo, O=Rivancorp, OU=SiteJP, E=sitejp@rivancorp.com
  subject-alt-name sitejp.rivan.com
  subject-alt-name jp.rivan.com
  storage unix: 
  primary
  revocation-check none
  rsakeypair rivankeys
  exit
 crypto pki authenticate rivantrust
> Paste the CA



6. Generate a CSR for both Routers

!@VPN-PH, VPN-JP
crypto pki enroll rivantrust

> Outputs a CSR . Must be signed by the CA



7. Import the CSR to the CA Server (NetOps)

!@NetOps
nano req-ph.pem
> paste VPN-PH's CSR
> ctrl + s (save)
> ctrl + x (exit)


!@NetOps
nano req-jp.pem
> paste VPN-JP's CSR
> ctrl + s (save)
> ctrl + x (exit



8. Sign the CSRs

!@NetOps
openssl x509 -req -in req-ph.pem -CA ca-rivan.pem -CAkey key-rivan.pem -out signed-ph.pem
openssl x509 -req -in req-jp.pem -CA ca-rivan.pem -CAkey key-rivan.pem -out signed-jp.pem

include subject names:
-subj "/C=PH/ST=NCR/L=Makati/O=Rivancorp/OU=SitePH/CN=siteph.rivan.com/emailAddress=siteph@rivancorp.com/subjectAltName=DNS:siteph.rivan.com,DNS:ph.rivan.com,IP:208.8.8.11"
-subj "/C=JP/ST=Kanto/L=Tokyo/O=Rivancorp/OU=SiteJP/CN=sitejp.rivan.com/emailAddress=sitejp@rivancorp.com/subjectAltName=DNS:sitejp.rivan.com,DNS:jp.rivan.com,IP:208.8.8.12"
 
!@NetOps - obtain the signed CSRs
cat signed-rivansitea.pem
cat signed-rivansiteb.pem


6. Import the signed CSRs

!@VPN-PH, VPN-JP
conf t
 crypto pki import rivantrust certificate

> Paste the signed CSR


_____________________
********************* Configure GRE over IPSec via Certificate Authentication

1. GRE Tunnel

!@VPN-PH
conf t
 int tun1
  ip add 172.16.10.1 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.12
  tunnel mode gre ip
  end

!@VPN-PH
conf t
 int tun1
  ip add 172.16.10.2 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.11
  tunnel mode gre ip
  end


2. Routing Interesting traffic

!@VPN-PH
conf t
 ip route 20.20.20.48 255.255.255.248 172.16.10.2
 end
 
!@VPN-JP
conf t
 ip route 10.10.10.32 255.255.255.224 172.16.10.1
 end


3. Configure ISAKMP Policy

!@VPN-PH, VPN-JP
conf t
 crypto isakmp policy 1
  authentication rsa-sig
  encryption aes 256
  hash sha512
  group 14
  end


4. Configure IPSec Profile

!@VPN-PH, VPN-JP
conf t
 crypto ipsec transform-set IPSECTUNNEL esp-aes 256 esp-sha-hmac
  mode transport
  exit
 crypto ipsec profile RIVAN
  set transform-set IPSECTUNNEL
  set pfs group14
  end


5 Apply IPSec Profile Protection to Tunnel

!@VPN-PH, VPN-JP
conf t
 int tunnel 1
  tunnel protection ipsec profile RIVAN 
  end


_____________________
********************* Verification

!@VPN-PH, VPN-JP
show crypto isakmp sa
show crypto ipsec sa













Other

crypto isakmp key secretkey address 133.33.33.2
